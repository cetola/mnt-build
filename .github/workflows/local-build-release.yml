name: Local Build and Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set permissions and build Docker container
        run: |
          cd scripts
          chmod +x build-container.sh run-container.sh
          ./build-container.sh

      - name: Run build-auto.py inside container
        id: run_build
        continue-on-error: true
        run: |
          cd scripts
          ./run-container.sh "python3 build-auto.py"

      - name: Run headers-gen.py inside container
        id: run_headers
        continue-on-error: true
        run: |
          cd scripts
          ./run-container.sh "python3 headers-gen.py"

      - name: Collect logs
        if: always()
        run: |
          mkdir -p release-artifacts/logs

          echo "Copying logs..."
          find . -maxdepth 1 -name "*.log" -type f -print -exec cp {} release-artifacts/logs/ \;
          find ./scripts -name "*.log" -type f -print -exec cp {} release-artifacts/logs/ \;

          echo "Log archive contents:"
          ls -al release-artifacts/logs

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: release-artifacts/logs

      - name: Find and collect tarballs
        id: collect_artifacts
        if: ${{ steps.run_build.outcome == 'success' && steps.run_headers.outcome == 'success' }}
        run: |
          HEADERS_TARBALL=$(find . -name "headers-*-mnt.tar.gz" -type f)
          KERNEL_TARBALL=$(find . -name "kernel-*-mnt.tar.gz" -type f)

          echo "Found tarballs:"
          echo "Headers: $HEADERS_TARBALL"
          echo "Kernel: $KERNEL_TARBALL"

          mkdir -p release-artifacts

          if [ -n "$HEADERS_TARBALL" ]; then
            cp "$HEADERS_TARBALL" release-artifacts/
          fi

          if [ -n "$KERNEL_TARBALL" ]; then
            cp "$KERNEL_TARBALL" release-artifacts/
          fi

          echo "Artifacts directory contents:"
          ls -lh release-artifacts/

      - name: Upload artifacts
        if: ${{ steps.collect_artifacts.conclusion == 'success' }}
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: release-artifacts/*-mnt.tar.gz

      - name: Create Release
        if: >
          startsWith(github.ref, 'refs/tags/') &&
          steps.run_build.outcome == 'success' &&
          steps.run_headers.outcome == 'success'
        uses: softprops/action-gh-release@v1
        with:
          files: release-artifacts/*-mnt.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

